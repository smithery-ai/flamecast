name: Smithery Flamecast
description: Run Claude Code to make changes and open a PR

inputs:
  prompt:
    description: "Prompt for Claude Code"
    required: true
  claude_code_oauth_token:
    description: "Claude Code OAuth token"
    required: true
  flamecast_pat:
    description: "GitHub PAT for cross-repo operations"
    required: false

runs:
  using: composite
  steps:
    - name: Configure git identity
      id: user
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.flamecast_pat || github.token }}
      run: |
        USER_ID=$(gh api /users/"$GITHUB_ACTOR" --jq '.id')
        git config --global user.name "$GITHUB_ACTOR"
        git config --global user.email "${USER_ID}+${GITHUB_ACTOR}@users.noreply.github.com"
        echo "id=$USER_ID" >> "$GITHUB_OUTPUT"

    - name: Run Claude Code
      id: claude
      uses: anthropics/claude-code-action@main
      with:
        prompt: ${{ inputs.prompt }}
        claude_code_oauth_token: ${{ inputs.claude_code_oauth_token }}
        github_token: ${{ inputs.flamecast_pat }}
        base_branch: ${{ inputs.base_branch || 'main' }}
        bot_id: ${{ steps.user.outputs.id }}
        bot_name: ${{ github.actor }}
        claude_args: |
          --dangerously-skip-permissions
