name: Flamecast
description: Run Claude Code to make changes and open a PR

inputs:
  prompt:
    description: "Prompt for Claude Code"
    required: true
  base_branch:
    description: "Base branch for the PR"
    required: false
    default: "main"
  target_repo:
    description: "Target repo (e.g. owner/repo). Leave empty for current repo."
    required: false
  claude_code_oauth_token:
    description: "Claude Code OAuth token"
    required: true
  flamecast_pat:
    description: "GitHub PAT for cross-repo operations"
    required: false

runs:
  using: composite
  steps:
    - name: Generate branch name
      id: branch
      shell: bash
      env:
        PROMPT: ${{ inputs.prompt }}
      run: |
        SLUG=$(echo "$PROMPT" | tr '[:upper:]' '[:lower:]' | tr -cs '[:alnum:]' '-' | cut -c1-20 | sed 's/-$//')
        HASH=$(echo -n "$PROMPT" | sha256sum | head -c 7)
        echo "name=flamecast/${SLUG}-${HASH}" >> "$GITHUB_OUTPUT"

    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.target_repo || github.repository }}
        token: ${{ inputs.target_repo && inputs.flamecast_pat || github.token }}
        fetch-depth: 0

    - name: Switch to branch
      shell: bash
      env:
        BRANCH: ${{ steps.branch.outputs.name }}
        BASE: ${{ inputs.base_branch || 'main' }}
      run: |
        git fetch origin
        if git ls-remote --exit-code --heads origin "$BRANCH" > /dev/null 2>&1; then
          git checkout "$BRANCH"
        else
          git checkout "$BASE" 2>/dev/null || git checkout "origin/$BASE"
          git checkout -b "$BRANCH"
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Run Claude Code
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.claude_code_oauth_token }}
        PROMPT: ${{ inputs.prompt }}
      run: |
        npx -y @anthropic-ai/claude-code --print --dangerously-skip-permissions "$PROMPT"

    - name: Commit and push
      id: commit
      shell: bash
      env:
        PROMPT: ${{ inputs.prompt }}
        BRANCH: ${{ steps.branch.outputs.name }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        if git diff --cached --quiet; then
          echo "No changes to commit"
          echo "has_changes=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi
        TRUNCATED=$(echo "$PROMPT" | head -c 72)
        git commit -m "flamecast: ${TRUNCATED}"
        git push origin "$BRANCH"
        echo "has_changes=true" >> "$GITHUB_OUTPUT"

    - name: Open or update PR
      if: steps.commit.outputs.has_changes == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.target_repo && inputs.flamecast_pat || github.token }}
        PROMPT: ${{ inputs.prompt }}
        BRANCH: ${{ steps.branch.outputs.name }}
        BASE: ${{ inputs.base_branch || 'main' }}
        TARGET_REPO: ${{ inputs.target_repo }}
      run: |
        REPO_FLAG=""
        if [ -n "$TARGET_REPO" ]; then
          REPO_FLAG="--repo $TARGET_REPO"
        fi
        if gh pr view "$BRANCH" $REPO_FLAG --json state -q '.state' 2>/dev/null | grep -q OPEN; then
          echo "PR already exists"
        else
          TITLE="flamecast: $(echo "$PROMPT" | head -c 72)"
          gh pr create \
            --base "$BASE" \
            --head "$BRANCH" \
            --title "$TITLE" \
            --body "Prompt: $PROMPT" \
            $REPO_FLAG
        fi
