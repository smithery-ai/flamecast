name: Flamecast
description: Run Claude Code to make changes and open a PR

inputs:
  prompt:
    description: "Prompt for Claude Code"
    required: true
  base_branch:
    description: "Base branch for the PR"
    required: false
    default: "main"
  target_repo:
    description: "Target repo (e.g. owner/repo). Leave empty for current repo."
    required: false
  claude_code_oauth_token:
    description: "Claude Code OAuth token"
    required: true
  flamecast_pat:
    description: "GitHub PAT for cross-repo operations"
    required: false

outputs:
  claude_logs:
    description: "Claude Code combined stdout/stderr logs"
    value: ${{ steps.claude.outputs.logs }}
  pr_url:
    description: "Created or existing pull request URL (empty when no PR)"
    value: ${{ steps.pr.outputs.url }}

runs:
  using: composite
  steps:
    - name: Generate branch name
      id: branch
      shell: bash
      env:
        PROMPT: ${{ inputs.prompt }}
      run: |
        SLUG=$(echo "$PROMPT" | tr '[:upper:]' '[:lower:]' | tr -cs '[:alnum:]' '-' | cut -c1-20 | sed 's/-$//')
        HASH=$(echo -n "$PROMPT" | sha256sum | head -c 7)
        USER="${GITHUB_ACTOR}"
        echo "name=flamecast/${USER}/${SLUG}-${HASH}" >> "$GITHUB_OUTPUT"

    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.target_repo || github.repository }}
        token: ${{ inputs.target_repo && inputs.flamecast_pat || github.token }}
        fetch-depth: 0

    - name: Switch to branch
      shell: bash
      env:
        BRANCH: ${{ steps.branch.outputs.name }}
        BASE: ${{ inputs.base_branch || 'main' }}
      run: |
        git fetch origin
        if git ls-remote --exit-code --heads origin "$BRANCH" > /dev/null 2>&1; then
          git checkout "$BRANCH"
        else
          git checkout "$BASE" 2>/dev/null || git checkout "origin/$BASE"
          git checkout -b "$BRANCH"
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Run Claude Code
      id: claude
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.claude_code_oauth_token }}
        PROMPT: ${{ inputs.prompt }}
      run: |
        set -o pipefail
        LOG_FILE="${RUNNER_TEMP}/claude.log"
        npx -y @anthropic-ai/claude-code --print --dangerously-skip-permissions "$PROMPT" 2>&1 | tee "$LOG_FILE"
        {
          echo "logs<<__FLAMECAST_LOGS__"
          cat "$LOG_FILE"
          echo "__FLAMECAST_LOGS__"
        } >> "$GITHUB_OUTPUT"

    - name: Commit and push
      id: commit
      shell: bash
      env:
        PROMPT: ${{ inputs.prompt }}
        BRANCH: ${{ steps.branch.outputs.name }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        if git diff --cached --quiet; then
          echo "No changes to commit"
          echo "has_changes=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi
        TRUNCATED=$(echo "$PROMPT" | head -c 72)
        git commit -m "flamecast: ${TRUNCATED}"
        git push origin "$BRANCH"
        echo "has_changes=true" >> "$GITHUB_OUTPUT"

    - name: Generate PR description
      id: pr_description
      if: steps.commit.outputs.has_changes == 'true'
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.claude_code_oauth_token }}
        BASE: ${{ inputs.base_branch || 'main' }}
      run: |
        # Check for PR template
        TEMPLATE_PROMPT=""
        if [ -f ".github/PULL_REQUEST_TEMPLATE.md" ]; then
          TEMPLATE_PROMPT="Use the pull request template found at .github/PULL_REQUEST_TEMPLATE.md to structure the description."
        elif [ -f ".github/pull_request_template.md" ]; then
          TEMPLATE_PROMPT="Use the pull request template found at .github/pull_request_template.md to structure the description."
        elif [ -f "PULL_REQUEST_TEMPLATE.md" ]; then
          TEMPLATE_PROMPT="Use the pull request template found at PULL_REQUEST_TEMPLATE.md to structure the description."
        elif [ -f "docs/PULL_REQUEST_TEMPLATE.md" ]; then
          TEMPLATE_PROMPT="Use the pull request template found at docs/PULL_REQUEST_TEMPLATE.md to structure the description."
        fi

        # Generate PR description using Claude
        PR_PROMPT="Review the git diff between $BASE and HEAD. Generate a comprehensive pull request description that explains what changes were made and why. $TEMPLATE_PROMPT Be concise but informative. Output ONLY the PR description text, no additional commentary."

        set -o pipefail
        PR_DESC=$(npx -y @anthropic-ai/claude-code --print --dangerously-skip-permissions "$PR_PROMPT" 2>&1 | tail -n +2)

        # Save to output using heredoc
        {
          echo "description<<__FLAMECAST_PR_DESC__"
          echo "$PR_DESC"
          echo "__FLAMECAST_PR_DESC__"
        } >> "$GITHUB_OUTPUT"

    - name: Open or update PR
      id: pr
      if: steps.commit.outputs.has_changes == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.target_repo && inputs.flamecast_pat || github.token }}
        PROMPT: ${{ inputs.prompt }}
        BRANCH: ${{ steps.branch.outputs.name }}
        BASE: ${{ inputs.base_branch || 'main' }}
        TARGET_REPO: ${{ inputs.target_repo }}
        PR_DESCRIPTION: ${{ steps.pr_description.outputs.description }}
      run: |
        REPO_FLAG=""
        if [ -n "$TARGET_REPO" ]; then
          REPO_FLAG="--repo $TARGET_REPO"
        fi
        if gh pr view "$BRANCH" $REPO_FLAG --json state -q '.state' 2>/dev/null | grep -q OPEN; then
          echo "PR already exists"
        else
          TITLE="flamecast: $(echo "$PROMPT" | head -c 72)"
          gh pr create \
            --base "$BASE" \
            --head "$BRANCH" \
            --title "$TITLE" \
            --body "$PR_DESCRIPTION" \
            $REPO_FLAG
        fi
        PR_URL=$(gh pr view "$BRANCH" $REPO_FLAG --json url -q '.url')
        echo "url=$PR_URL" >> "$GITHUB_OUTPUT"
